<%= stylesheet_link_tag('jquery.facebook.multifriend.select','jquery.facebook.multifriend.select-list','challenges.css','simple-tabs','jquery-ui', 'ui.core','ui.progressbar','ui.theme', 'main')%>
<%= javascript_include_tag('jquery.facebook.multifriend.select','jquery.facebook.multifriend.select.min','simple-tabs','ui.progressbar','on_the_spot')%>
<%= render 'layouts/loggedinbody'%>
<% as= current_user.challenges.size %>

<div style="margin-top:0px;",class="topbar" bgcolor=#f4f4f4>
	<table bgcolor=#f4f4f4>
		<tr>
			<td width="470px">
			</td>
			<td  width="100px">
				<%= render :partial => 'invitations' %>
			</td>
			<td width="200px" class="profile_name">
				<font color="gray"> <b  id="image" ></b></font>
			</td>
			<td>
			</td>
		</tr>
	</table>
</div>
<style>
	.profile_name
			{
				position:relative;
				top: -10px;
			}
			#topbar{
			margin-top:0px;
						   }
</style>

<div id="ch_main_div3">
	<p class="user"><font color="orange"><%=current_user.facebook.name%></font></p>
	<table border="1px">
		<tr width="600px">
			<td width="100px" height="200px" id="image1" align="left">
			</td>
			<td width="570px" height="200px">
				<table border =5 bordercolor=#f4f4f4>
					<tr>
						<td width="100px">
							<!--<font color="#999999"><b>TROPHIES</b></font>--></td>
						</td>
						<td align="left">
							<!--<font color="gray">No of trophies</font>-->
						</td>
					</tr>
				</table>
				<table>
					<tr>
						<td width="100px">
							<font color="#999999"><b>MEMBER SINCE</b></font></td>
						</td>
						<td align="left">
							<%  user = User.find(:all)%>
							<%= current_user.created_at%>
						</td>
					</tr>
				</table>
				<hr/>
				<table border =5 bordercolor=#f4f4f4>
					<tr>
						<td width="100px">
							<font color="#999999"><b>ACHIEVEMENTS</b></font>
						</td>
						<td align="left">
							<% sum=0 %>
							<% current_user.challenges.each  do |ch| %>
								<% t= 0 %>
								<% ch.tasks.each do |tasks| %>
								<% t = t+1 %>
								<% end %>
								<% sum = sum + t %>
							 <% end %>
							<font color="gray"><b><%= current_user.challenges.length %>&nbsp;Challenges&nbsp;and&nbsp;<%= sum%>&nbsp;tasks</b></font>
						</td>
					</tr>
				</table>
				
				<hr/>
				
				<table height="10px">
					<tr height="10px">
						<td width="100px" height="10px">
							<font color="#999999"><b> CURRENT CITY</b></font></td>
						</td>
						<td align="left" height="10px">
							<p id="location"></p>
						</td>
					</tr>
				</table>
					<hr/>
				<table>
					<tr>
						<td width="100px">
							<font color="#999999"><b>HOME CITY</b></font></td>
						</td>
						<td align="left">
							<p id="hometown"></p>
						</td>
					</tr>
				</table>
				<hr/>
				<table>
					<tr>
						<td width="100px">
							<font color="#999999"><b> SEX</b></font></td>
						</td>
						<td align="left"  id="image2">
							<%=  %>
						</td>
					</tr>
				</table>
				<hr/>
				<table>
					<tr>
						<td width="100px">
							<font color="#999999"><b>BIRTH DAY</b></font></td>
						</td>
						<td align="left" id="image3">
							<%= current_user.facebook.birthday %>
						</td>
					</tr>
				</table>
				<hr/>
				<table>
					<tr>
						<td width="100px">
							<font color="#999999"><b>ABOUT ME</b></font></td>
						</td>
						<td align="left">
							<%  about_me = current_user.facebook.bio %>
							<%= about_me  %>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	 </table>
	<table width="100%" border="0" style="margin-top:0px;">
		<tr>
			<td colspan="3">
    			<ul class="tabs">
    				<li><a href="#tab1"><b>MY DOJO</b></a></li>
    				<li><a href="#tab2"><b>CHALLENGES</b></a></li>
				</ul>
	<div class="tab_container1">
    	<div id="tab1" class="tab_content2">
		<table bgcolor=#F4F4F4 height="30px">
							<tr bgcolor=#F4F4F4>
								<% allConnections = UserConnection.find(:all, :conditions =>["user_id=?", current_user.id]) %>
								<% group =Array.new %>
								<% allConnections.each  do |eachConnection| %>
									<% group.push(eachConnection.target_id) %>
								<% end %>
									<script>
										function contactToInvitee() 
										{
										 var contact = '<%= group.join(",") %>';
										 window.fbAsyncInit();
											FB.ui({
											  method: 'send',
											  to:contact,
											  name: 'Facebook Dialogs',
											  link: 'https://developers.facebook.com/docs/reference/dialogs/'
													 });										 
										 }
									</script>			
								 <td width="440px" height="40px">
									<b >Total:	<%= group.length %><b id="total"></b><%= image_tag("btn_msg_up.png", :onclick=>"contactToInvitee()") %>
								</td>
							<td width = "80px" id="search"  height="40px">
									</td>
								<td width="30px"  height="40px">
									<p class="invite"><%= link_to ( image_tag ("search_it.PNG") , :class=>"image_tag") %><p>
								</td>
								<td  height="40px" width="50px">
									<p class="invite"><%= render :partial => 'invitations' %>
									<%= hidden_field_tag "myvar", 0%>	
									</p>
								</td>
							</tr>
						</table>
    		<table width="100%" border="0">
  				<tr>
    				<td>
						
						
   <style>
				.filterform {
					position :relative;
					top: -10px;
									}
				.filterinput {
					width :200px;
					height:25px;
					position :relative;
					top: 15px;
									}
				.text_field {
					width :200px;
					height:25px;
									}
				.user {
					font-size :20px;
					text-transform: uppercase;
							}
				.invite {
				position :relative;
					top: 15px;
							}
			</style>
									
						<table  border="0"> 
							<tr bgcolor=#d7d7d7>
								<td>NAME
								</td>
								<td  width="100px">
									STATUS
								</td>
							</tr>
						</table>
						<table bgcolor="white">
							<tr>
								<td>
									<div id="wrap">
										<h1 id="header"></h1>
										<table bgcolor="white">
											<tr>
												<td id="list">
													<% allConnections = UserConnection.find(:all, :conditions =>["user_id=?", current_user.id]) %>
													<% allConnections.each  do |eachConnection| %>
														<%#= eachConnection.target_id %></br>
														<%#= eachConnection.id %>
														<table width="720px">
															<tr >
																<td width="670px" >		
																    <p>
																		<a href="#"  id="ahref"><%=image_tag(FbGraph::User.new(eachConnection.target_id).fetch.picture) %>
																		<b><%= FbGraph::User.new(eachConnection.target_id).fetch.name %></b>
																	
																		<script>
																			var user_id= <%= eachConnection.target_id %>
																		</script>
																		
																		<script>
																			function testing(user_id)
																			  {
																			 var myFriends =user_id;
																					window.fbAsyncInit();
																			FB.ui({
																				  method: 'send',
																				  to:myFriends,
																				  name: 'Facebook Dialogs',
																				  link: 'https://developers.facebook.com/docs/reference/dialogs/'
																				  });
																				  }
																		</script>
																       
																		<span id="icon"> 
																				<%= link_to image_tag('btn_msg_up.png',:onclick =>"testing(user_id);")%>
																	
																				<%= link_to image_tag("btn_delete_up.png"), user_connection_path(eachConnection.id), :confirm => 'Remove from myDojo?', :method => :delete %>
																		</span>
																	</a>
																	</p>	
																</td>
															</tr>
														</table>
													<% end %>
												</td>
											</tr>	
										</table>
									</div> 
								</td>
							</tr>
						</table> 
					</td>
                </tr>
            </table>				
		</div>
			<style type="text/css">
			#icon
			{ 
			
		    margin-left:560px;
			margin-top: 0px;
			margin-right:-50px
			
			} 
				#names
			{ 
			float: left;
			width: 660px;
			} 
		
			 #ahref
			{					
			width:600px;
			color:#000000;
			top:5px;
			bottom:10px;
			
			}
			</style>	
</style>																
<script src="http://code.jquery.com/jquery-1.4.2.min.js"></script>
<script>
	(function ($) {
	  jQuery.expr[':'].Contains = function(a,i,m){
		  return (a.textContent || a.innerText || "").toUpperCase().indexOf(m[3].toUpperCase())>=0;
	  };

	  function listFilter(header, list) {
		var form = $("<form>").attr({"class":"filterform","action":"#"}),
			input = $("<input>").attr({"class":"filterinput","type":"text"});
		$("#search").append($(form).append(input).appendTo(header));

		$(input)
		  .change( function () {
			var filter = $(this).val();
			if(filter) {
			  $(list).find("a:not(:Contains(" + filter + "))").parent().slideUp();
			  $(list).find("a:Contains(" + filter + ")").parent().slideDown();
			} else {
			  $(list).find("p").slideDown();
			}
			return false;
		  })
		.keyup( function () {
			$(this).change();
		});
	  }
	  $(function () {
		listFilter($("#header"), $("#list"));
	  });
	}(jQuery));
</script> 			
		<div id="tab2" class="tab_content2">
					<div class="dashboardsidebar">
						<div style=" width:860px; ", class="mychallenge">
							<div style=" width:860px; ", "id="titlechallenge">
								<div  style="height : 40px;  width:860px;", id="title">
									MY CHALLENGES <font color="black"><b>( <%= as %> ) </b></font>
								</div>
								<div class="second_titlechallenge">
									<%= button_to "", new_challenge_url, :class => "new_challenge_button1", :method => :get%>
								</div>
							</div>						
							
							<div style="overflow-y: auto; overflow-x: hidden;  height : 420px;  width:860px;" id="challengedetails",style=" width:860px; ">
								<% t=1 %>
								<script src="http://www.kryogenix.org/code/browser/sorttable/sorttable.js"> </script>
								<table  class="sortable">
								<thead>
								  <tr><th style="CURSOR: pointer; cursor: hand;" id="content1">NAME</th><th style="CURSOR: pointer; cursor: hand;" id="content2">MY DOJITSU SCORE</th></tr>
								</thead>
								<tbody>
									<% current_user.challenges.each do |userChallenge| %>
									<tr id="challengetr" style=" width:100%; CURSOR: pointer; cursor: hand;" onclick="location.href='<%= show_per_challenges_path(:id => userChallenge)  %>'" >
										<td >
											
											<font family="Arial" color="#666666" size=3"><b><%= userChallenge.title %></b></font><br><font size=2>by </font>
											
											
											
											<% if userChallenge.instance_of?ChildChallenge %>
											   <% @parentChallenge = Challenge.where(:_id => userChallenge.challenge_id).first%>
											   <script>
												var ordId = <%=  orgId = @parentChallenge.user_id %>
											   </script>
											   <b><%= FbGraph::User.new(@parentChallenge.user_id).fetch.name %></b>
											<% else %>
												<b><%= current_user.facebook.name %></b>
											<% end %>
											
											
											
											
											
											</font><br><%=  userChallenge.start_point.value %> - <%= userChallenge.end_point.value %><br>
											<%if ( userChallenge.child_challenges.size <2 ) %> 
												<%= userChallenge.child_challenges.size >0 ? userChallenge.child_challenges.size : 1  %> contestant<br>
											<% else %>
												<%= userChallenge.child_challenges.size %> contestants<br>
											<% end %>
										
										</td>
										<td >					
											<div class="taskprogress" id="taskprogress<%= t %>">
											</div>
											
											
										<br/>
											<div id="check1">
												<% x=0 %>
												<% y=0 %>
												<% a= 0 %>
												<% b= 0 %>
												<% userChallenge.tasks.each do |aTask| %>
										
													<% if (aTask.is_complete == 1 ) %>
														<% a+=Integer(aTask.score) %>
														<% x+=1 %>
													<% else %>
														<% b += aTask.score.to_i %>
														<% y+=1 %>
													<% end %>
												<% end %>
												
											<div class="update">
												<%#= image_tag("FDFDG.gif", :alt => "Update")%>												
											</div>
											<div class="completedtask"> 
												<%= a %> points (<%= x %> &nbsp; tasks)
											</div>
											<div class="notcompleted">
												<font size=3 color="#F8981D"><b>to go:</b></font>&nbsp; <font color="white"><%= b %> points (<%= y %>&nbsp; tasks)</font>
											</div>
												<script type="text/javascript">
													$(function() {
														$("#taskprogress<%= t %>").progressbar({ value: Math.round(((<%= a %>/<%= (a+b) %>)*100)) });
														$("<p>").attr("id", "check").text($("#taskprogress<%= t %>").progressbar("option", "value") + "% Completed:  ").appendTo("#taskprogress<%= t %>");
													});
												</script>
											</div>
											<div id="points">
												&nbsp;&nbsp;<font size=4><b><%= a %></b></font>
											</div>
																		
										</td>
																												
										<% t+=1 %>																
										
									</tr>
							
									
									<% end %>
								</tbody>

								</table>
							</div>
						</div>
					</div>
		</div>
</div>
</div>			
		</td>
	</tr>
</table>	
 <script>
	window.fbAsyncInit();
		  FB.getLoginStatus(function(response) { 
             if (response.session)
				{ 
                   globaluserid=response.session["uid"]; 
					 name=globaluserid;
				 FB.api( 
                     { 
                        method: 'fql.query',
                         query: 'SELECT uid1 FROM friend WHERE uid2='+globaluserid
                      },
                    function(response)
                      {
					FB.api({
						method: 'fql.query',
								 query: 'SELECT name,pic_big,sex,birthday FROM user WHERE uid=' + name
								}, function(response){                                                               
										htmlcontent = '<img src=' + response[0].pic_big+ ' />';																
										htmlcontent1=response[0].name
										htmlcontent2=response[0].sex
										htmlcontent3=response[0].birthday														
										$("#image").append(htmlcontent1);   
										$("#image1").append(htmlcontent);   
										$("#image2").append(htmlcontent2);   
										$("#image3").append(htmlcontent3);   
								}); 
			} 
                        ); 
		FB.api('/me', function(response) {
			var location = response.location.name;
			var hometown = response.hometown.name;
			$("#hometown").append(hometown);
			$("#location").append(location);
																});
				FB.api(
				{
				method: 'permissions.request',
				perms:  'user_birthday',
				},
				function(response) {
				console.log(response);
				FB.api('/me', function(response){
				console.log(response);
				display: 'none'
				var bir =response[0].birthday;
				var email=response[0].email;
				});
				}
				);
            }
    }); 		
 </script>	
	
