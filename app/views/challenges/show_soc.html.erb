<%= stylesheet_link_tag('simple-tabs','datePicker','colorbox','jquery.cluetip.css','jquery-ui','ui.progressbar','ui.theme', 'main', 'challenges_social', 'challenges')%>
<%= javascript_include_tag('simple-tabs','tabs2','ui.progressbar.js','ajaxPageLoad','soc-per','on_the_spot','jquery.colorbox-min','jquery.tools.min','messages','fbWallPost')%>
<%= render 'layouts/loggedinbody'%>

<section class="challengeSubNav">
	<%= button_to "", new_challenge_url, :class => "new_challenge_button_new1", :method => :get %>
    <%= link_to "MY CHALLENGES >> ", challenges_url ,  :class => "challenge_link1" %>
	<%= link_to "#{@challenge.title}","#" ,  :class => "challenge_link1" %> 
</section>
<% name_search = 0%>

<% if params[:isNewChallenge] == "isNew" %>
    <script> 
      $.dojitsuWallPost.renderFbWallPost();
    </script>
<% end %>    

<% if !@challenge.child_challenges.blank? && userIds = []%>
    <% for aChild in @challenge.child_challenges %>
        <% if aChild.social_type.status.nil?%>
           <% userIds.push(aChild.user_id)  %>
        <% end %>
    <% end %>
    <% if isStandalone %>
        <% if !userIds.empty? and @challenge.user_id == current_user.gmauth.id%>
            <script type="text/javascript" charset="utf-8">
            $.dojitsu.renderSendBox(<%= "'"+@challenge.title + "'" %>, <%= "'"+userIds.join(",") +"'"%>, <%= "'http://www.dojitsu.com" + "'"%>, <%=	"'"+ challenge_url(@challenge) +"'"%>, fbCallback).replace("'", "");	

            function fbCallback(response){
                if(response == null){
                } else
                {
                  var srt = '<%= params[:id] %>';
                  jQuery.support.cors = true;
                  $.get('/challenges/update_status_af_meg', 
                    {thinking_abt:srt},
                    function(data) {

                    }, 'script'
                  );
                }
            }
            </script>
    <% end %>

    <% else %>
        <% if !userIds.empty? and @challenge.user_id == current_user.fbauth.uid%>
            <script type="text/javascript" charset="utf-8">
            $.dojitsu.renderSendBox(<%= "'"+@challenge.title + "'" %>, <%= "'"+userIds.join(",") +"'"%>, <%= "'http://www.dojitsu.com" + "'"%>, <%=	"'"+ challenge_url(@challenge) +"'"%>, fbCallback).replace("'", "");	

            function fbCallback(response){
              if(response == null){
              } else
              {
                  var srt = '<%= params[:id] %>';
                  jQuery.support.cors = true;
                  $.get('/challenges/update_status_af_meg', 
                      {thinking_abt:srt},
                      function(data) {

                      }, 'script'
                  );
              }
            }
            </script>
        <% end %>
    <% end %>        
<% end %> 

<table width="100%">	
<tbody>
<tr>	
  <td valign="top" width="60%" >
    <table>
        <tr>
       		<td valign="top">
       			<section  class="mychallenges">
               <% if @challenge.user_id == current_user.fbauth.uid %>
						<% unless @challenge.social_type.status.to_i == 1 %>
								<span class="challange"><%= @challenge.title %>	</span> 
						<%else%>
								<span class="challange" id ="updatetitle" onclick="TestingTitle();"><%= @challenge.title %>	</span> 
						<%end%>
               <% else %>
                  <span class="challange"><%= @challenge.title %>	</span> 
               <% end %>	
               <section id="replacedTitle">
		              <%= text_field(:challenge, :title, :maxlength =>30, :class => "titlewidth")%>
		              <%= link_to image_tag("update.png", :class =>"replacetitle"), show_per_challenges_path(:id => @challenge.id) %>
		              <%= link_to "CANCEL", show_per_challenges_path(:id => @challenge.id), :class => "replace_cancel" %>
               </section>
               <script>
               $("#replacedTitle").hide();
               function TestingTitle()
               {
                  $("#updatetitle").replaceWith($("#replacedTitle").show());
               }

               $('.replacetitle').click(function()
               {
                   var startValue1 = $("#challenge_title").val();
                   var challengeId = '<%= @challenge._id %>'
                   jQuery.support.cors = true;
                   var objj = {
                        myParams11:startValue1,
                        myParams21:challengeId
                      };

                   $.get('/challenges/title_soc_update',
                   {value:objj},
                   function(data) {

                   }, 'script'
                   );
               });
               </script>
               <br><br>
              
					<% unless @challenge.social_type.status.to_i == 1 %>
		              <table width="100">
		                   <tr >
		                        <td >  
		                           <%= link_to image_tag("accepted.png"), update_status_challenges_path(:id => @challenge, :status=> 1), :onclick=>"fun();" %>
		                        </td> 
		                        <td  cellpadding="2">
		                           <%= link_to(image_tag("declane.png"), update_status_challenges_path(:id => @challenge, :status=> -1))%>
		                        </td>
		                        <td width="100%" cellpadding="2">
		                           <%= image_tag("thinkbutton.png") %>
		                        </td>
		                   </tr>
		              </table>
               <% end %>	
               <script>
               function fun()
               {
		            window.fbAsyncInit();
		            var body = 'Accepted challenge';
		            FB.api('/me/feed', 'post', { message: body }, function(response) {
                    if (!response || response.error) {
                       alert('Error occured');
                    } else {
                       alert('Post ID: ' + response.id);
                    }
		            });
         }
       </script>							
       <script type="text/javascript">
       $(document).ready(function(){
		    $("#image1").hide();
		    $("#image2").hide();
		    $("#image3").hide();
		    $("#image4").hide();
		    $("#image5").hide();
		      $("#description").mouseover(function(){
		         $("#image1").show()
		      });
		    $("#organizer").mouseover(function(){
		         $("#image2").show();
		      });
		         $("#startdate").mouseover(function(){
		         $("#image3").show();
		      });
		    $("#enddate").mouseover(function(){
		         $("#image4").show();
		      });
		    $(document).mouseout(function(){
              $("#image1").hide();
              $("#image2").hide();
              $("#image3").hide();
              $("#image4").hide();
      			//	$("#image5").hide();
		     });
		});
		</script>
	<table valign="top">
	<tr>
		<td>
		    <section>
		        <table id="description" >
		             <tr>
		                 <td height="34px" width="100px" valign="top">
		                     <span class="colorligtblk1">DESCRIPTION<b ></span>
		                 </td >
		                 <td valign="top">
		                     <% if @challenge.user_id == current_user.fbauth.uid %>
		                         <section class="onthespandescription" >
		                             <span class ="updatedesccolo" ><%= @challenge.description %>											    			 									           </span> 
		                         </section>
		                     <% else %>
                               <section>
                                   <span class ="updatedesccolo" ><%= @challenge.description %></span> 
                               </section>
		                     <% end %>	
                           <section id="replacedDescription">
                               <%= text_area(:challenge, :description, :class => "textareastyle" )%>
                               <%= link_to image_tag("update.png", :class =>"replacedesc"), show_per_challenges_path(:id => @challenge.id) %>
                               <%= link_to "CANCEL", show_per_challenges_path(:id => @challenge.id), :class => "replace_cancel_desc1" %>
                           </section>
		                 </td>
							  <% unless @challenge.social_type.status.to_i == 1 %>
									<td width ="20"></td>													
									<%else%>
										<% if @challenge.user_id == current_user.fbauth.uid %>
										<td valign="top" width ="20" onclick="TestingDesc();">
											<span id="image1"><%= image_tag("icon_edit.png") %></span>
										</td>
										<% else %>
											<td width ="20"></td>
										<%end%>
									<%end%>		                                                            
		             </tr>
		        </table>
		          <script>
	                  $("#replacedDescription").hide();
	                  function TestingDesc()
	                  {
	                      $(".onthespandescription").replaceWith($("#replacedDescription").show());
	                  }

	                  $('.replacedesc').click(function()
	                  {
                          var startValue2 = $("#challenge_description").val();
                          var challengeId = '<%= @challenge._id %>'
                          jQuery.support.cors = true;
                          var objj = {
                          myParams11:startValue2,
                          myParams21:challengeId
                          };
                          $.get('/challenges/desc_soc_update',
                          {value:objj},
                          function(data) {

                          }, 'script'
	                  );
	                  });
                   </script>
                   <section>
                      <hr/>
                   </section>
                  <section>
                  <table id="organizer">
                    <tr>
                         <td height="34px" width="100px">
                             <span class="colorligtblk1">ORGANIZER</span>
                         </td>
                         <td >

                         <% if @challenge.instance_of?ChildChallenge%>
                          <%  @parentChallenge = Challenge.where(:_id => @challenge.challenge_id).first%>
                          <script>
                           var ordId = <%=  orgId = @parentChallenge.user_id %>
                          </script>
                             <b><span class ="updatedesccolo" > <%= FbGraph::User.new(@parentChallenge.user_id).fetch.name %></span></b>
                         <% else %> 
                             <b><span class ="updatedesccolo"  id="user_name"><%= FbGraph::User.new(@challenge.user_id).fetch.name %></span></b>
                          <script>
                           var ordId = <%=  orgId = @challenge.user_id %>
                          </script>
                         <% end %>
                         </td>
                    </tr>
                    <tr>
                       <hr/>
                    </tr>
                  </table>
          			</section>
                   <section>
                           <hr/>
                   </section>
                   <section>
                   <table id="startdate">
                     <tr>
                       <td height="34px" width="100px">
                            <b class="colorligtblk">START POINT</b>
                       </td>
                       <td >
                            <% if @challenge.start_point.instance_of?PointDateType %>		
                                 <b class="colordarkblk"><%= @challenge.start_point.value.strftime("%b %d, %Y") %> </b>
                            <% else %>							
                                 <b class="colordarkblk"><%= @challenge.start_point.value.to_i %></b>
                             <% end %>
                       </td>
                         <!-- <% if @challenge.user_id == current_user.fbauth.uid %>
                           <td valign="top" width="12%" onclick="TestingDesc();">
                               <span id="image3"><%= image_tag("icon_edit.png") %></span>
                           </td>
                           <% else %>
                               <td width="12%"></td>
                         <%end%>
                         -->
                     </tr>
                   </table>
           </section>		
           <section>
               <hr/>
           </section>
                <section>
                <table id="enddate">
                  <tr> 
		                 <td height="34px" width=100px>
		                     <b class="colorligtblk">END POINT</b>
		                 </td>
		                 <td>
                         <% if @challenge.end_point.instance_of?PointDateType %>		
                                  <b class="colordarkblk"><%= @challenge.end_point.value.strftime("%b %d, %Y") %></b>
                         <% else %>							
                                  <b class="colordarkblk"><%= @challenge.end_point.value.to_i %></b>
                         <% end %>
		                 </td>
		                 <!-- <% if @challenge.user_id == current_user.fbauth.uid %>
                         <td valign="top" width="12%" onclick="TestingDesc();">
                                 <span id="image4"><%= image_tag("icon_edit.png") %></span>
                         </td>
                         <% else %>
                                 <td width="12%"></td>
		                 <%end%> -->
                  </tr>
                 </table>
        			  </section>
				     <section>
				             <hr/>
				     </section>	
                </tr>
            </table>
				</section>
            </td>
         </tr>	
			<!--		
			<tr>
            <td>
                <section class="mychallengea">
                      <%= render :partial=> "challenges/againstothers" %>
                </section>
				</section>
            </td>					
          </tr>			
          <tr>
              <td>
                  <section class="mychallengeb">
							 <table width="100%" class="marginalign">
								  <tr>
										<td>
											 <ul class="tabs">
											      <li><a href="#tab7"><b>TASKS</b></a></li>
											      <li><a href="#tab8"><b>SCOREBOARD</b></a></li>
											 </ul>
											 <section class="tab_container">
												  <section id="tab7" class="tab_content" style="background:white;">
												      <%= render :partial=> "challenges/tasksupdate" %>
												  </section>
												  <section id="tab8" style="background:white;" class="tab_content">
												      <section class="tables">
												           <%= render :partial=> "challenges/scoreboard" %>			
												      </section>   
												  </section> 
											 </section> 
										</td>
								  </tr>
							 </table>
                  </section>
              </td>
          </tr>
			-->			
        </table>
    </td>
	<!--	
    <td width="40%" valign="top">
      <section class="mychallengec">
          <%= render :partial => "challenges/people_status" %>
      </section>
    </td>
	-->	
</tr>
</tbody>
</table>
	<style>
.mychallenges {
    
    
    float: left;
    max-height: auto;
	width: 570px;
}
.mychallengea {
   
   
    float: left;
	max-height: auto;
	width: 570px;
    
}
.mychallengeb {
    
   
    float: left;
	max-height: auto;
    width: 570px;
}
.mychallengec {
   
   
    float: left;
	max-height: auto;
    width: 100%;
	
}

</style>	

<script>
    $("#replacedDescription").hide();
    function TestingDesc()
    {
       $(".onthespandescription").replaceWith($("#replacedDescription").show());
    }

    $('.replacedesc').click(function()
    {
      var startValue2 = $("#challenge_description").val();
      var challengeId = '<%= @challenge._id %>'
      jQuery.support.cors = true;
      var objj = {
      myParams11:startValue2,
      myParams21:challengeId
      };
      $.get('/challenges/desc_soc_update',
      {value:objj},
      function(data) {

      }, 'script'
      );
    });
</script>


<input type="button" value="Marak Complete" class="links_score_p" onclick="winnerList();"/>
<style>
  #winList{
    width: 100%;
    background-color: #F4F4F4;    
    font-size: 18px;
    color: #666666;
    font-weight:bold;
    padding-left: 20px;
    padding-top: 10px;
  }
  
  #winListM{
    width: 95%;
    background-color: #FFFFFF;    
    font-size: 14px;
    color: #666666;
    font-weight:bold;
    padding: 10px 10px 10px 20px;
  }
  
  #winListMNo{
    background-color: #f4f4f4;
    border: 2px;
    border-style:solid;
    border-color: #D0D0D0;
    margin-top: 10px;
    padding: 10px 10px 10px 20px;
  }

  #winListMNoEdit{
    background-color: #f4f4f4;
    border: 2px;
    border-style:solid;
    border-color: #D0D0D0;
    margin-top: 10px;
    padding: 10px 10px 10px 20px;
  }	
  
  #winListMNoL{
    margin-top: 10px;
    background-color: #ffffff;
  }

  #addPersonalM{
    margin-top:10px;	
  }
	
  #addPersonalMm{
    margin-top:10px;
    hight:100px;	
  }

	.textareaMessage{
		border-width: 1px;
		border-style: solid;
		border-color: #999999;
		background-color:#F4F4F4;
		background-repeat: repeat-x;
		font-family: Arial;
		font-size: 15px;
		color: #333333;
		resize: none;
		height: 50px;	
		width:98%;
	}

	.linksMWinner {
		background: none repeat scroll 0 0 #f9a943;
		border-radius: 3px 3px 3px 3px;
		color: #FFFFFF;
		display: block;
		font-size: 12px;
		margin: 20px 0;
		padding: 5px;
		text-align: center;
		text-transform: uppercase;
		width: 90px;
		margin-right:10px;
		position: relative;
		text-align: center;
		top: -20px;
}

	#sentMessage{
		color: #666666;
}

</style>

<section style="display: none">
  <section id="winList">
    Publish the winners!
    <section id="winListM">
      Here's the list of winner(s) for <%= @challenge.title %>. On your approval, the winner(s) will be published to Facebook.
      <section id="winListMNo">
        No of winners:&nbsp;<%= @challenge.social_type.how_many_winners %><%= image_tag("icon_edit.png", :style=>"float:right;", :id=>"editWinner" )%>
        <table id="winListMNoL" width="100%">
          <thead>          
            <th>Rank</th>
            <th>Name</th>
            <th></th>
            <th></th>
            <th>Score</th>
          </thead>
          <tbody>            
	    <% if @challenge.instance_of?ChildChallenge %>
		<% @fetChallenge = Challenge.where(:_id => @challenge.challenge_id).first%>
	    <% else %>
		 <% @fetChallenge = Challenge.where(:_id => params[:id]).first%>
	    <% end %>
            <% @flag = 1 %>
            <% @latestScore = 1 %>
              <% sl=0 %>
              <% if @fetChallenge.social_type.who_win == "Highest number of points" %>
                  <% @all =  Challenge.winner(@fetChallenge.id) %>
              <% end %>
              <% if @fetChallenge.social_type.who_win == "Participant completes all tasks" %>
                  <% @all =  Challenge.winnerCompleteAllTask(@fetChallenge.id) %>
              <% end %>
              <% if @fetChallenge.social_type.who_win == "Lowest number of points" %>
                  <% @temp =  Challenge.winner(@fetChallenge.id) %>
                  <% @all = @temp.sort {|a,b| a[1] <=> b[1]} %>
              <% end %>			
							<% if @fetChallenge.social_type.who_win == "1st person to reach End Point" %>
                  <% @temp =  Challenge.winnerFirstPersonReach(@fetChallenge.id) %>
                  <% @all = @temp.sort {|a,b| a[1] <=> b[1]} %>
              <% end %>
				  <% @allParticipants = [] %>
				  <% @allWinners = [] %>
				  <% @all.each do |aWinner,index| %>
				  		<% @allParticipants.push(aWinner) %>
				  <% end %>		
              <% @all.each do |aWinner,index| %>
						<% @allWinners.push(aWinner) %>
                  <tr>
                      <td class="bordercolor">
                        <% if @flag == 1 %>
                          gold
                          <%= image_tag("trophy_gold.png") %>                          
                          <% @latestScore = index %>
                          <% @flag += 1 %>
                        <% elsif @flag == 2 %>
                          <% if @latestScore == index %>
                            gold
                            <%= image_tag("trophy_gold.png") %>                            
                          <% else %>
                            silver
                            <%= image_tag("trophy_green.png") %>                            
                            <% @latestScore = index %>
                            <% @flag += 1 %>
                          <% end %>              
                        <% elsif @flag == 3 %>              
                          <% if @latestScore == index %>
                            silver
                            <%= image_tag("trophy_green.png") %>                            
                          <% else %>
                            bronze
                            <%= image_tag("trophy_orange.png") %>                            
                            <% @latestScore = index %>
                            <% @flag += 1 %>
                          <% end %> 
                        <% elsif @flag == 4 %>
                          <% if @latestScore == index %>
                            bronze
                            <%= image_tag("trophy_orange.png") %>                            
                          <% else %>
                            blue
                            <%= image_tag("trophy_blue.png") %>                            
                            <% @latestScore = index %>
                            <% @flag += 1 %>
                          <% end %>                
                        <% elsif @flag == 5 %>
                          <% if @latestScore == index %>
                            blue
                            <%= image_tag("trophy_blue.png") %>                            
                          <% else %>
                            red
                            <%= image_tag("trophy_purple.png") %>                            
                            <% @latestScore = index %>
                            <% @flag += 1 %>
                          <% end %>                
                        <% elsif @flag == 6 %>
                          <% if @latestScore == index %>
                            red
                            <%= image_tag("trophy_purple.png") %>                            
                          <% else %>
                            platinum
                            <%= image_tag("trophy_platinum.png") %>                            
                            <% @latestScore = index %>
                            <% @flag += 1 %>
                          <% end %>                
                        <% else %>

                        <% end %>
                      </td>
                      <td class="bordercolor"><div align="center">
									<%#=image_tag(FbGraph::User.new(aWinner).fetch.picture) %></div>
							 </td>
                      <td class="bordercolor"><div align="center" style="float:left">
									<%#= FbGraph::User.new(aWinner).fetch.name %></div>
		      			 </td>               
                      <td class="bordercolor">
								<div align="center">
									<section id="taskpercentages">
										<section id="winnerListProgressPercentage<%= aWinner %>">				
									</section>            
								</section>
								</div>
							 </td>			                    
    						<td class="bordercolor">
								<% eachChallenge = Challenge.all(conditions: {:user_id => aWinner, :title=>@fetChallenge.title}).first %>
								<% total_score = 0 %>
									<% total_score_count = 0 %>
									<% total = 0 %>              
									<% eachChallenge.tasks.each do |aTask| %>
								<% total += aTask.score.to_i %>
								<% if (aTask.is_complete == 1 ) %>
									<% total_score+=Integer(aTask.score) %>  
									<% total_score_count += 1 %>                  				                       
								<% end %>
								<%end%>											            
								<section style="width:200px">                
								<section class="task" id="winnerListProgress<%= aWinner %>"></section>
									<section id="sblackbox_personal">
										<section class="snotcompleted2">
											<span class="tasks_color"><%= total_score %></span> <font color="gray" weight="bold" size="4px">points </br><%= total_score_count %>&nbsp; tasks</font>
										</section>                   
									</section>
								<br>
								</section>	
								<script type="text/javascript">
									$(function() {
									$("#winnerListProgress<%= aWinner %>").progressbar({ value: Math.round(((<%= total_score %>/<%= total %>)*100)) });					
									$("<p>").attr("id", "spercentage_personal").text($("#winnerListProgress<%= aWinner %>").progressbar("option", "value") + "%").appendTo("#winnerListProgressPercentage<%= aWinner %>");			
									});
								</script>																							     	 	            
							</td>							
                  </tr>
                  <% sl +=1 %>
                  <% if sl.to_i == @challenge.social_type.how_many_winners.to_i %>
                      <% break %>
                  <% end %>						
              <% end %>		
          </tbody>
        </table>
      </section>
		

		







			
			















		</section>   
  </section>
</section>

<script type="text/javascript">

$(document).ready(function(){
	$("#sentMessage").click(function(){
		$("#addPersonalM").hide();
		$("#addPersonalMm").show();	
	});
				
});

function winnerList()
{  
  $(document).ready(function(){
        $.colorbox({
          opacity: 0.40,
          transition: 'none',
          speed: 200,
          width: 700,
          scrolling: true,
          inline:true, 
          href:"#winList",
          title: '',
          overlayClose: true,
          onComplete: function () {
              // $(this).initFunctions(); // if you want to reinit another colorbox, you should pass the element as an argument to initFunctions rather than calling this as a blanket initializer for all colorboxes.
          }              
      });
    });
}
</script>

<div id="fb-root"></div>

<script type="text/javascript" charset="utf-8">
	$(document).ready(function(){
   	$("#approve").click(function(){

			$.dojitsu.renderSendBox(<%= "'"+@challenge.title + "'" %>, <%= "'"+@allParticipants.join(",") +"'"%>, <%= "'http://www.dojitsu.com" + "'"%>, <%=	"'"+ challenge_url(@challenge) +"'"%>, fbCallback).replace("'", "");	

            function fbCallback(response){
              if(response == null){
              } else
              {
                  var srt = '<%= params[:id] %>';
                  jQuery.support.cors = true;
                  $.get('/challenges/update_status_af_meg', 
                      {thinking_abt:srt},
                      function(data) {

                      }, 'script'
                  );
						var winnerDetails = new Object();
						winnerDetails.winners = '<%= @all %>',
						winnerDetails.title = '<%= @challenge.title %>',
						winnerDetails.noOfWinner = '<%= @fetChallenge.social_type.how_many_winners %>', 	
						//var allWinns = '<%= @allWinners %>','<%= @challenge.title %>';
						//var title = '<%= @challenge.title %>';                  
						$.get('/messages/storeWinner', winnerDetails );

              }
            }
		});
	});
</script>

<script>
	$(document).ready(function(){
		$('#editWinner').click(function(){
			$("#winListMNo").hide();
			$("#winListMNoEdit").show();
			//alert("Maisa")
		});		
	});
</script>

<%#= @challenge.user_id%>
<%#= @allParticipants %>
<%#= @allWinners %>









