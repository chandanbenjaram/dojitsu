<%= stylesheet_link_tag('simple-tabs','jquery-ui','ui.progressbar','ui.theme', 'main')%>
<%= javascript_include_tag('simple-tabs','ui.progressbar.js','soc-per','messages')%>

<div id="ch_main_div"> 
    <div id="ch_main_div1"> 
        <div style=" font-size: 25px; font-weight: bold;" class="challange"> 
            <%= @challenge.title%>
        </div> 							
        <div>
            <table >
                <tr>
                    <td width="80px">
                         <b><font color= #999999>DESCRIPTION</font></b></td>
                    <td width="500px">
                         <b><%= @challenge.description %></b>
                    </td>
                </tr>
            </table>
        </div>	
        <div>
            <table width="500px">
                <tr>
                    <td width="130px" class="titles">
                            <b><font color= #999999>ORGANIZER</font></b>
                    </td>
                    <td >
                        <% if @challenge.instance_of?ChildChallenge%>
                            <%  @parentChallenge = Challenge.where(:_id => @challenge.challenge_id).first%>
                            <script>
                                    var ordId = <%=  orgId = @parentChallenge.user_id %>
                            </script>
                            <b><%= FbGraph::User.new(@parentChallenge.user_id).fetch.name %></b>
                        <% else %>	
                            <b id="user_name"></b>
                            <script>
                                    var ordId = <%=  orgId = @challenge.user_id %>
                            </script>
                        <% end %>	
                    </td>
                    <td width="100px">
                        <%= image_tag("btn_msg_up.png", :onclick=>"contactToOrganizer(ordId)" ) %>
                    </td>
                </tr>
                <tr>
                    <hr/>
                </tr>
            </table>
        </div>
        <div>
            <hr/>
        </div>
        <div>
            <table>
                <tr>
                    <td width=130px>
                         <b><font color= #999999>START POINT</font></b>
                    </td>
                    <td>
                        <% if @challenge.start_point.instance_of?PointDateType %>		
                                 <b><%= @challenge.start_point.value.strftime("%b %d, %Y") %> </b>
                        <% else %>							
                                <b><%= @challenge.start_point.value.to_i %></b>
                        <% end %>
                    </td>
                </tr>
            </table>
        </div>			
        <div>
              <hr/>
        </div>
        <div>
            <table>
                <tr> 
                    <td width=130px>
                        <b><font color= #999999>END POINT</font></b>
                    </td>
                    <td>
                        <% if @challenge.end_point.instance_of?PointDateType %>		
                                <b><%= @challenge.end_point.value.strftime("%b %d, %Y") %></b>
                        <% else %>							
                                <b><%= @challenge.end_point.value.to_i %></b>
                        <% end %>
                    </td>
                </tr>
            </table>
        </div>
        <div>
             <hr/>
        </div>	
        <table>
            <tr>
                <td width="130px" class="titles">
                     <b><font color= #999999>PARTICIPANTS</b></font>
                </td>
                <td>
                <% if @challenge.social_type.status == 1 &&  @challenge.class.to_s == "ChildChallenge" %>
                     <b><%= @challenge.parent.child_challenges.length %></b>
                <% else %>
                    <% if @challenge.social_type.status == 1 %>
                            <b><%= @challenge.child_challenges.length %></b>
                    <% else %>
                            <b><%= @challenge.parent.child_challenges.length %></b>
                    <% end %>
                <% end %>
                </td>
            </tr>
        </table>
        <input type="hidden" name="thinking_abt" id="thinking_abt" value="<%= @challenge.id %>"> 
        <table width="100%" border="0" style="margin-top:0px;">
            <tr>
                <td colspan="3">
                    <ul class="tabs">
                        <li><a href="#tab1"><b>TASKS</b></a></li>
                        <li><a href="#tab2"><b>PEOPLE</b></a></li>
                    </ul>
                    <div class="tab_container">
                        <div id="tab1" style="background:#F5F5F5;" class="tab_content">
                            <% if(@challenge.social_type.status? and @flg.to_s == "ed") %>
                                    <%= render :partial=> "challenges/tasks_edit" %>
                            <% else %>
                                    <%= render :partial=> "challenges/nonLoginTasks" %>																										
                            <% end %>
                        </div>
                        <div id="tab2" style="background:#F5F5F5;" class="tab_content">
                            	<div class="tables">

				<table>
					<td width="47%">
							<label for="search">
							<strong>
							<% if  @challenge.class.to_s == "Challenge" %>
																<font size="4" color="#8c8c8c"><b  id="total">Total: <%= @challenge.child_challenges.length %></b></font>
															<%else %>
																<font size="4" color="#8c8c8c"> <b  id="total">Total: <%= @challenge.parent.child_challenges.length %></b></font>
															<% end %>
															<% if @challenge.instance_of?Challenge %>
																<%= image_tag("btn_msg_up.png", :style=>"margin-left:10px; position:relative; top:5px;" ,:onclick=>"contactToInvitee()")%>
															<% end %>
							</strong>
							</label>
					</td>
					<td><input type="text" id="search" /></td>
					<script>
					function search()
					{
					var name_search=document.getElementById("search").value;
				     select();				
					}
					</script>
					<td><div class="styled-select"> <select id="select">
							<option value="All" id="select">ALL</option>
							<option value="1" id="select">ACCEPTED</option>
							<option value="pending" id="select">PENDING</option>
							<option value="-1" id="select">DECLINED</option>
						</select> </div>
					</td>
					<td>
					 <%=image_tag("searchbutton.PNG",  :onclick=>"search();" )%>
		       <%#= link_to(image_tag("declane.png"), filter_challenges_path(:id => @challenge)) %>
					</td>
				</table>
				<table width="100%"  class="sortable" border=1>
				<thead>
				<tr>
				<th width="85%"><b style="position:relative; color:#666666; padding-left:20px; " >NAME</b></th>
				<th width="15%"><b style=" color:#666666;  " >STATUS </b></th>
				</tr>
				</thead>
				</table>
				<table width="100%" id="tblData" class="sortable" border=1>
				<tbody bgcolor="#ffffff">
					<tr >
				     <td >
					 <div id="name">
				
					 </div>
					</td>		
				</tr>
				<div id ="all">
				</div>
					 <script>
					 	<%if @challenge.parent .nil? %>
																	   <% childChallenges =  @challenge.child_challenges %>
																	  <%else%>
																	   <%childChallenges =  @challenge.parent.child_challenges %>
																	   <%end%>       
			 htmltable="<table><% childChallenges.each do |aChildChallenge| %> <tr><td><img src="+"<%= FbGraph::User.new(aChildChallenge.user_id).fetch.picture %>"+"><%= FbGraph::User.new(aChildChallenge.user_id).fetch.name %></td><td> <% if aChildChallenge.social_type.status.nil? or aChildChallenge.social_type.status == 0 %>pending<% elsif aChildChallenge.social_type.status == 1 %>accepted<% else %>declined<% end %></td></tr><% end %></table>";
					 		document.getElementById("name").innerHTML =htmltable
					 </script>
	 <script>
	(function ($) {
	  jQuery.expr[':'].Contains = function(a,i,m){
		  return (a.textContent || a.innerText || "").toUpperCase().indexOf(m[3].toUpperCase())>=0;
	  };

	  function listFilter(header, list) {
		var form = $("<form>").attr({"class":"filterform","action":"#"}),
			input = $("<input>").attr({"class":"filterinput","type":"text"});
		$("#search").append($(form).append(input).appendTo(header));

		$(input)
		  .change( function () {
			var filter = $(this).val();
			if(filter) {
			  $(list).find("a:not(:Contains(" + filter + "))").parent().slideUp();
			  $(list).find("a:Contains(" + filter + ")").parent().slideDown();
			} else {
			  $(list).find("p").slideDown();
			}
			return false;
		  })
		.keyup( function () {
			$(this).change();
		});
	  }

	  $(function () {
		listFilter($("#header"), $("#list"));
	  });
	}(jQuery));
</script> 
					<script>
							
							 function select()
							 {
							//   $("#all").hide();
							 //  $("#all").replaceWith($("#name")
								 var select= document.getElementById("select").value
								 var name_search=document.getElementById("search").value;
								 <%if @challenge.parent .nil? %>
											   <% childChallenges =  @challenge.child_challenges %>
											  <%else%>
											   <%childChallenges =  @challenge.parent.child_challenges %>
											   <%end%>                      
												  <% childChallenges.each do |aChildChallenge| %>
														var challenge_status="<%= aChildChallenge.social_type.status %>";
																	if (select == "All")
																	 {
																	 var status = 2
																	 }
																	 if (select == "1")
																	 {
																	 var status = 1
																	 }
																	 if (select == "pending")
																	 {
																	 var status = 0
																	 }
																	 if (select == "-1")
																	 {
																	 var status = -1
																	 }
								                  <% end %>
							 <%if @challenge.parent .nil? %>
												   <% childChallenges =  @challenge.child_challenges %>
												  <%else%>
												   <%childChallenges =  @challenge.parent.child_challenges %>
												   <%end%>                      
												<% childChallenges.each do |aChildChallenge| %>
														  var check_name= "<%= FbGraph::User.new(aChildChallenge.user_id).fetch.name %>";
														  var name_search=document.getElementById("search").value;
														  var challenge_status="<%= aChildChallenge.social_type.status %>";
																	if (name_search == check_name &&  challenge_status==1 && status==1)
																		{
																	var str = "<%= FbGraph::User.new(aChildChallenge.user_id).fetch.picture %>";
																		htmltr_open='<img src=' + str+ ' />';
																		var check_name= "<%= FbGraph::User.new(aChildChallenge.user_id).fetch.name %>";
																		document.getElementById("name").innerHTML ="<table><tr><td width="+"84%"+"><img src="+"<%= FbGraph::User.new(aChildChallenge.user_id).fetch.picture %>"+"><%= FbGraph::User.new(aChildChallenge.user_id).fetch.name %></td><td><img src="+"/assets/icon_accept.png"+"></td></tr></table>";
																		
														}
																	if (name_search == check_name &&  challenge_status==-1 && status==-1)
																		{
																		var str = "<%= FbGraph::User.new(aChildChallenge.user_id).fetch.picture %>";
																		htmltr_open='<img src=' + str+ ' />';
																		var check_name= "<%= FbGraph::User.new(aChildChallenge.user_id).fetch.name %>";
																		var challenge_status="<%= aChildChallenge.social_type.status %>";
																		document.getElementById("name").innerHTML ="<table><tr><td width="+"84%"+"><img src="+"<%= FbGraph::User.new(aChildChallenge.user_id).fetch.picture %>"+"><%= FbGraph::User.new(aChildChallenge.user_id).fetch.name %></td><td><img src="+"/assets/icon_decline.png"+"></td></tr></table>";
																		
																		}
																	 if (name_search == check_name && status==0 && challenge_status==0)
																			{
																		var str = "<%= FbGraph::User.new(aChildChallenge.user_id).fetch.picture %>";
																		htmltr_open='<img src=' + str+ ' />';
																		var check_name= "<%= FbGraph::User.new(aChildChallenge.user_id).fetch.name %>";
																		var challenge_status="<%= aChildChallenge.social_type.status %>";
																		document.getElementById("name").innerHTML ="<table><tr><td width="+"84%"+"><img src="+"<%= FbGraph::User.new(aChildChallenge.user_id).fetch.picture %>"+"><%= FbGraph::User.new(aChildChallenge.user_id).fetch.name %></td><td><img src="+"/assets/icon_thinking.png"+"></td></tr></table>";
			
																			}
																	if (name_search == check_name && status==2)
																			{
																			var str = "<%= FbGraph::User.new(aChildChallenge.user_id).fetch.picture %>";
																		htmltr_open='<img src=' + str+ ' />';
																		var check_name= "<%= FbGraph::User.new(aChildChallenge.user_id).fetch.name %>";
																		var challenge_status="<%= aChildChallenge.social_type.status %>";
																	document.getElementById("name").innerHTML ="<table><tr><td width="+"84%"+"><img src="+"<%= FbGraph::User.new(aChildChallenge.user_id).fetch.picture %>"+"><%= FbGraph::User.new(aChildChallenge.user_id).fetch.name %></td><td><img src="+"/assets/icon_thinking.png"+"></td></tr></table>";
																	
																			}
												<% end %>		
												 if( status==2 && name_search ==="" ||  status==2 && name_search ==="nil" ||  status==2 && name_search ===null   )
														{
															<%if @challenge.parent .nil? %>
																	   <% childChallenges =  @challenge.child_challenges %>
																	  <%else%>
																	   <%childChallenges =  @challenge.parent.child_challenges %>
																	   <%end%>                      
                                                         htmltable="<table><% childChallenges.each do |aChildChallenge| %> <tr><td><img src="+"<%= FbGraph::User.new(aChildChallenge.user_id).fetch.picture %>"+"><%= FbGraph::User.new(aChildChallenge.user_id).fetch.name %><% if aChildChallenge.social_type.status.nil? or aChildChallenge.social_type.status == 0 %><img src="+"icon_thinking.png"+"><% elsif aChildChallenge.social_type.status == 1 %><img src ="+"icon_accept.png"+"><% else %><img src ="+"icon_decline.png" +"><% end %></td></tr><% end %></table>";
														
														}
												else if( status==1 && name_search ==="" ||  status==1 && name_search ==="nil" ||  status==1 && name_search ===null    )
														{
															<%if @challenge.parent .nil? %>
																	   <% childChallenges =  @challenge.child_challenges %>
																	  <%else%>
																	   <%childChallenges =  @challenge.parent.child_challenges %>
																	   <%end%>                      
                                                         htmltable="<table><% childChallenges.each do |aChildChallenge| %><% if aChildChallenge.social_type.status == 1 %> <tr><td><img src="+"<%= FbGraph::User.new(aChildChallenge.user_id).fetch.picture %>"+"><%= FbGraph::User.new(aChildChallenge.user_id).fetch.name%></td><td>accepted<td></tr><% end %><% end %></table>";
														document.getElementById("name").innerHTML =htmltable
														}
														else if(  status==0 && name_search ==="" ||  status==0 && name_search ==="nil" ||  status==0 && name_search ===null   )
														{
														 <%if @challenge.parent .nil? %>
																	   <% childChallenges =  @challenge.child_challenges %>
																	  <%else%>
																	   <%childChallenges =  @challenge.parent.child_challenges %>
																	   <%end%>                      
                                                         htmltable="<table><% childChallenges.each do |aChildChallenge| %><% if aChildChallenge.social_type.status.nil? or aChildChallenge.social_type.status == 0 %> <tr><td width="+"84%"+"><img src="+"<%= FbGraph::User.new(aChildChallenge.user_id).fetch.picture %>"+"><%= FbGraph::User.new(aChildChallenge.user_id).fetch.name %></td><td><img src="+"/assets/icon_thinking.png"+"></td></tr><% end %><% end %></table>";
														document.getElementById("name").innerHTML =htmltable
														}
														else if(  status==-1 && name_search ==="" ||  status==-1 && name_search ==="nil" ||  status==-1 && name_search ===null   )
														{
														<%if @challenge.parent .nil? %>
																	   <% childChallenges =  @challenge.child_challenges %>
																	  <%else%>
																	   <%childChallenges =  @challenge.parent.child_challenges %>
																	   <%end%>                      
                                                         htmltable="<table><% childChallenges.each do |aChildChallenge| %><% if aChildChallenge.social_type.status == -1 %> <tr><td ><img src="+"<%= FbGraph::User.new(aChildChallenge.user_id).fetch.picture %>"+"><%= FbGraph::User.new(aChildChallenge.user_id).fetch.name %></td><td><img src="+"\/assets/icon_decline.png"+"></td></tr><% end %><% end %></table>";
														document.getElementById("name").innerHTML =htmltable
													}
													
															<%if @challenge.parent .nil? %>
																	   <% childChallenges =  @challenge.child_challenges %>
																	  <%else%>
																	   <%childChallenges =  @challenge.parent.child_challenges %>
																	   <%end%>       
																	   	<% childChallenges.each do |aChildChallenge| %>
													else if(name_search==check_name && status!="") 
													{
													
																		  if(status==2)
																	   {
																	   
																		
																		var str = "<%= FbGraph::User.new(aChildChallenge.user_id).fetch.picture %>";
																		htmltr_open='<img src=' + str+ ' />';
																		var check_name= "<%= FbGraph::User.new(aChildChallenge.user_id).fetch.name %>";
																	
																		document.getElementById("name").innerHTML =htmltr_open+check_name+challenge_status																		   
												
																		
																		}
																		else if(status!=challenge_status)
																	   {
																		document.getElementById("name").innerHTML ="No such Reocrds found .........."
																		}
													}
													<% end %>
							}
							 </script>
						<td></td>
					

				</tr>
			
				</tbody>
				</table>
				</div>
                            </div> 
                            <script>
                            $(document).ready(function() 
                            { 
                                    $("#btnFilter").click(function() 
                                    { 
                                            var selection = $("#catSelect").val(); 
                                             if (selection == "all") 
                                            { 
                                                    $(".item").show(); 
                                            } 
                                            else 
                                            { 
                                                    $(".item").hide(); 
                                                    $("."+selection).show(); 
                                            } 
                                    }); 
                            });
                            </script>                           
                            <style type="text/css">
                            #status_icon
                            { 
                            float: right;
                            width: 80px;
                            } 
                             #ahref
                            {     
                            color:#000000;
                            }
                            </style>                
                            <script>
                             (function (cash) {
                               jQuery.expr[':'].Contains = function(a,i,m){
                                    return (a.textContent || a.innerText || "").toUpperCase().indexOf(m[3].toUpperCase())>=0;
                               };

                               function listFilter(header, list) {
                              var form = $("<form>").attr({"class":"filterform","action":"#"}),
                               input = $("<input>").attr({"class":"filterinput","type":"text"});
                              $("#search").append($(form).append(input).appendTo(header));

                              $(input)
                                    .change( function () {
                               var filter = $(this).val();
                               if(filter) {
                                     $(list).find("a:not(:Contains(" + filter + "))").parent().slideUp();
                                     $(list).find("a:Contains(" + filter + ")").parent().slideDown();
                               } else {
                                     $(list).find("p").slideDown();
                               }
                               return false;
                                    })
                              .keyup( function () {
                               $(this).change();
                              });
                               }

                               $(function () {
                              listFilter($("#header"), $("#list"));
                               });
                             }(jQuery));
                            </script>
                        </div>
                    </div>
                </td>
            </tr>
        </table>  
    </div>		
<% orgIds = "" %>
	<script> 
		window.fbAsyncInit();
		FB.getLoginStatus(function(response) { 
		if (response.session)
        { 
		   globaluserid=response.session["uid"]; 
		   name=globaluserid;
		}
		}
		);
<% @challenge.child_challenges.each do |aTask| %>
						 var len = <%= @challenge.child_challenges.length %>
		var img = <%= aTask.user_id %>
						  FB.api({
				method: 'fql.query',
				query: 'SELECT name,pic_square FROM user WHERE uid=' + img
			}, function(response){
			htmlcontent = '<img src=' + response[0].pic_square + ' />'+ response[0].name ;
			 tableopen='<table>';
			 tropen='<tr>';
			 tdopen='<td >';
			 tdclose='</td>';
			 tdopen1='<td id="friendsstatus" >';
			 tdclose1='</td>';
			 trclose='<tr>';
			 tableclose='</table>'
			 hr = '<hr/>';
			 $("#friendlist").append(tableopen);
					$("#friendslist").append(tropen);
					$("#friendslist").append(tdopen);
					 $("#friendslist").append(htmlcontent);
					 $("#friendslist").append(tdclose);
					<% @challenge.child_challenges.each do |aTask| %>
						<% if aTask.user_id %>
							<% if aTask.social_type.status == 1  ||  @challenge.user_id == aTask.user_id %>
											status='<%= image_tag ("icon_accept.png") %>';
								<% else %>
								<% if aTask.social_type.status == 0 %>
											status='<%= image_tag ("icon_thinking.png") %>';
								<% else %>
											status='<%= image_tag("icon_decline.png") %>';
								<% end %>
							<% end %>
						<%end%>
								<%end%>		
					 $("#friendsstatus").append(tdopen1);
					 $("#friendsstatus").append(status);
					 $("#friendsstatus").append(tdclose1);
					 $("#friendslist").append(trclose);
					$("#friendslist").append(tropen);																
					$("#friendslist").append(hr);  
					$("#friendslist").append(trclose);
					 $("#friendslist").append(tableclose); 
			});
 <%end %>
				var user = <%= @challenge.user_id %>
					FB.api({
						method: 'fql.query',
					query: 'SELECT name FROM user WHERE uid=' +user
				}, function(response){
				htmlcontent =response[0].name ;
						$("#user_name").append(htmlcontent);    
			});
</script>

<style>
	.table{
		background:#ffffff;
	}
</style>

<script>
    function contactToOrganizer(orgId)
    {
        $.dojitsu.renderSendBox(<%= "'"+@challenge.title + "'" %>, <%= "'"+orgId+"'"%>, <%= "'http://www.dojitsu.com" + "'"%>, <%= "'"+ challenge_url(@challenge) +"'"%>);	
    }
</script>



